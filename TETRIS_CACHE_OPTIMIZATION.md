# Оптимизация вкладки Тетрис - Уменьшение лишних запросов

## Проблема

После сохранения результата игры Тетрис сразу вызывался `loadBestRecord()`, который каждый раз:
- Сбрасывал состояние `loading`
- Делал запрос к Supabase
- Вызывал мерцание UI

Это приводило к избыточной нагрузке на сервер и плохому пользовательскому опыту.

## Решение

### 1. Создан хук `useTetrisRecordCache`

Новый хук `src/hooks/useTetrisRecordCache.ts` предоставляет:

- **Кэширование рекордов** - данные сохраняются в `useRef` на 30 секунд
- **Умная проверка обновлений** - новый рекорд загружается только если он действительно лучше текущего
- **Единообразный API** - одинаковое поведение во всех компонентах Тетрис

```typescript
const { loadBestRecord, updateCacheIfBetter, getCachedRecord } = useTetrisRecordCache()
```

### 2. Оптимизированы компоненты

#### TetrisPage.tsx
- Убрано дублирование кода кэширования
- Используется новый хук для управления рекордами
- Устранено мерцание UI при сохранении рекордов

#### SimpleTetrisPage.tsx  
- Аналогичная оптимизация с использованием хука
- Улучшена производительность при частых играх

### 3. Логика оптимизации

```typescript
// Проверяем кэш перед запросом к серверу
if (!forceReload && 
    cacheRef.current.record && 
    (now - cacheRef.current.lastLoadTime) < cacheDuration) {
  return cacheRef.current.record // Используем кэш
}

// Проверяем, действительно ли новый рекорд лучше
const shouldUpdate = !currentBest || newRecord.score > currentBest.score
if (shouldUpdate) {
  // Обновляем кэш только если рекорд действительно лучше
  updateCache(newRecord)
}
```

## Результаты

### ✅ Устранены проблемы:
- **Мерцание UI** - состояние `loading` больше не сбрасывается без необходимости
- **Избыточные запросы** - сервер запрашивается только при реальной необходимости
- **Дублирование кода** - единый хук для всех компонентов Тетрис

### ✅ Улучшения:
- **Производительность** - кэширование на 30 секунд снижает нагрузку на сервер
- **UX** - плавная работа без мерцания интерфейса
- **Масштабируемость** - легко добавить кэширование в другие компоненты

### ✅ Технические детали:
- Кэш автоматически обновляется при лучших рекордах
- Возможность принудительного обновления через `forceReload`
- Логирование для отладки работы кэша
- TypeScript типизация для безопасности

## Использование

Хук можно использовать в любом компоненте, который работает с рекордами Тетрис:

```typescript
import { useTetrisRecordCache } from '../hooks/useTetrisRecordCache'

function MyTetrisComponent() {
  const { loadBestRecord, updateCacheIfBetter, getCachedRecord } = useTetrisRecordCache()
  
  // Загрузка рекорда (с кэшированием)
  const record = await loadBestRecord()
  
  // Проверка и обновление кэша при новом рекорде
  const wasUpdated = updateCacheIfBetter(newRecord)
  
  // Получение текущего кэшированного рекорда
  const cachedRecord = getCachedRecord()
}
```

## Конфигурация

Можно настроить время кэширования:

```typescript
const { loadBestRecord } = useTetrisRecordCache({ 
  cacheDuration: 60000 // 60 секунд вместо 30
})
```
