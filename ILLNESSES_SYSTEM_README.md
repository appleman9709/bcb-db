# Система отслеживания здоровья малыша

## Описание

Добавлена функциональность для отслеживания здоровья малыша: запись болезней/проблем, управление лекарствами и мазями, а также автоматические уведомления о приеме лекарств.

## Что было реализовано

### 1. База данных

**Новые таблицы:**
- `illnesses` - хранение болезней/проблем
- `medications` - хранение лекарств и мазей для лечения
- `medication_reminders` - запланированные напоминания о приеме лекарств

**Структура:**
- Болезнь может иметь несколько лекарств одновременно
- Каждое лекарство имеет расписание приема (перед/после/во время еды, количество раз в день, длительность)
- Автоматическое планирование напоминаний для каждого лекарства

### 2. Интерфейс

**Вкладка "Тамагочи":**
- Иконка "+" для добавления новой болезни
- Иконки активных болезней (можно нажимать для редактирования)
- Модальное окно для добавления болезни (квиз из 3 шагов)
- Модальное окно для редактирования болезни и лекарств

**Квиз добавления болезни:**
1. Название заболевания
2. Лекарства для приема по расписанию (Да/Нет)
   - Название лекарства/мази
   - Время приема (перед/после/во время еды)
   - Количество раз в день
   - Длительность приема (дни)
   - Возможность добавить несколько лекарств
3. Запись к врачу (Да/Нет)
   - Дата и время записи

### 3. Уведомления

**Автоматические напоминания:**
- Планируются автоматически при добавлении лекарства
- Учитывают время приема (перед/после/во время еды)
- Распределяются равномерно в течение дня
- Отправляются всем членам семьи через push-уведомления

**Расписание приема:**

Для лекарств с типом "Неважно":
- 1 раз в день: 12:00
- 2 раза в день: 8:00, 20:00
- 3 раза в день: 8:00, 14:00, 20:00
- 4 раза в день: 8:00, 12:00, 16:00, 20:00
- 5+ раз в день: равномерно с 8:00 до 20:00

Для лекарств, привязанных к кормлению:
- **Перед едой** - уведомление за 30 минут до следующего кормления (на основе интервала кормления)
- **После еды** - уведомление через 30 минут после кормления
- **Во время еды** - уведомление в момент кормления

Напоминания для лекарств, привязанных к кормлению, планируются динамически при каждом кормлении.

## Настройка

### Шаг 1: Создание таблиц в базе данных

Выполните SQL скрипт в Supabase SQL Editor:

```sql
-- Запустите database_illnesses.sql
```

Этот скрипт создаст:
- Таблицы `illnesses`, `medications`, `medication_reminders`
- Индексы для оптимизации запросов
- Триггеры для автоматического обновления `updated_at`
- RLS политики для безопасности

### Шаг 2: Настройка уведомлений

**Уведомления работают через клиентский процессор** (как и для кормления/подгузников):

- При загрузке приложения запускается `reminderProcessor`, который проверяет напоминания каждую минуту
- Обработка происходит через API endpoint `/api/push/process-reminders`, который обрабатывает:
  - Напоминания о кормлении и смене подгузников (из таблицы `scheduled_reminders`)
  - Напоминания о лекарствах (из таблицы `medication_reminders`)

**Преимущества:**
- ✅ Не зависит от ограничений Vercel cron jobs (Hobby тариф)
- ✅ Работает даже если cron job не настроен
- ✅ Проверяет напоминания каждую минуту (вместо раза в день)
- ✅ Работает пока приложение открыто

**Ограничения:**
- ⚠️ Напоминания обрабатываются только когда приложение открыто
- ⚠️ Если приложение закрыто, напоминания будут обработаны при следующем открытии
- ⚠️ Для работы в фоне нужно установить приложение как PWA

### Шаг 3: Перезапуск приложения

После выполнения SQL скрипта перезапустите приложение, чтобы изменения вступили в силу.

## Использование

### Добавление болезни

1. Откройте вкладку "Тамагочи"
2. Нажмите на иконку "+"
3. Заполните квиз:
   - Введите название заболевания
   - Укажите, есть ли лекарства (если да, добавьте их)
   - Укажите, есть ли запись к врачу (если да, укажите дату и время)
4. Нажмите "Сохранить"

### Редактирование болезни

1. Нажмите на иконку болезни в Тамагочи
2. В модальном окне можно:
   - Изменить название заболевания
   - Изменить дату и время записи к врачу
   - Добавить новые лекарства
   - Удалить существующие лекарства

### Уведомления

- Уведомления о приеме лекарств отправляются автоматически в запланированное время
- Все члены семьи получают уведомления
- Уведомление содержит название лекарства, болезнь и время приема

## Пример использования

**Пример:** Добавление болезни "Воспаление пальца на ноге"

1. Название: "Воспаление пальца на ноге"
2. Лекарства:
   - Мазь: 2 раза в день, перед едой, 7 дней
   - Антибиотики: 4 раза в день, перед едой, 5 дней
3. Запись к врачу: 15.01.2024, 14:00

После сохранения система автоматически:
- Создаст запись о болезни
- Добавит лекарства
- Запланирует напоминания для каждого приема лекарства
- Отправит уведомления в запланированное время

## Технические детали

### API Endpoints

- `POST /api/push/process-reminders` - обработка всех напоминаний (кормление, подгузники, лекарства)
  - Вызывается клиентским процессором каждую минуту
  - Обрабатывает напоминания из таблиц `scheduled_reminders` и `medication_reminders`

### Методы DataService

- `getIllnesses(activeOnly?: boolean)` - получение списка болезней
- `getIllness(id)` - получение болезни по ID
- `addIllness(illness)` - добавление болезни
- `updateIllness(id, updates)` - обновление болезни
- `deleteIllness(id)` - удаление болезни
- `getMedications(illnessId?)` - получение лекарств
- `addMedication(medication)` - добавление лекарства
- `updateMedication(id, updates)` - обновление лекарства
- `deleteMedication(id)` - удаление лекарства
- `scheduleMedicationReminders(medication)` - планирование напоминаний
- `getMedicationReminders(medicationId?, status?)` - получение напоминаний

## Примечания

- Болезни могут быть активными одновременно (несколько болезней)
- Лекарства автоматически планируют напоминания при добавлении
- При удалении лекарства все его напоминания отменяются
- При обновлении лекарства напоминания перепланируются

