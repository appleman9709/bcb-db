# Настройка cron-job.org для обработки напоминаний

## Обзор

Настроим внешний cron сервис cron-job.org для обработки напоминаний каждые 5 минут, даже когда приложение закрыто.

## Шаг 1: Регистрация на cron-job.org

1. Откройте [cron-job.org](https://cron-job.org)
2. Нажмите **"Sign Up"** или **"Create Account"**
3. Заполните форму регистрации:
   - Email
   - Пароль
   - Подтвердите email (проверьте почту)
4. Войдите в аккаунт

## Шаг 2: Создание нового Cron Job

1. После входа нажмите **"Create cronjob"** или **"New cronjob"**

2. Заполните форму:

   **Основные настройки:**
   - **Title:** `BabyCare Reminders Processor`
   - **Address (URL):** `https://your-project.vercel.app/api/push/process-reminders`
     - Замените `your-project.vercel.app` на ваш домен Vercel
     - Например: `https://bcb-db.vercel.app/api/push/process-reminders`
   
   **Метод запроса:**
   - **Method:** `POST`
   - **Request body:** Оставьте пустым (если нужно, можно добавить `{}`)

   **Расписание:**
   - **Schedule:** `*/5 * * * *` (каждые 5 минут)
     - Или выберите **"Every 5 minutes"** в интерфейсе

   **Дополнительные настройки:**
   - **Time zone:** Ваш часовой пояс (например, `Europe/Moscow` или `UTC`)
   - **Activate cronjob:** ✅ Включено

3. Нажмите **"Create cronjob"** или **"Save"**

## Шаг 3: Проверка работы

### Проверка 1: Тестовый запуск

1. В списке cron jobs найдите созданный job
2. Нажмите на иконку **"Play"** или **"Run now"** для тестового запуска
3. Проверьте статус выполнения:
   - **Success** - успешно
   - **Failed** - ошибка (проверьте URL и логи)

### Проверка 2: Проверка логов

1. В cron-job.org перейдите в **"Execution log"** или **"History"**
2. Проверьте последние выполнения:
   - Должен быть статус **200 OK** или **200 Success**
   - Если **404** или **500** - проверьте URL и настройки

### Проверка 3: Проверка в приложении

1. Создайте тестовое напоминание:
   ```javascript
   // В консоли браузера
   window.debugReminders.createTestReminder(1, 'diaper')
   ```

2. Подождите 5 минут (или запустите cron job вручную)

3. Проверьте статус напоминания:
   ```javascript
   window.debugReminders.checkScheduledReminders(1)
   ```

4. Уведомление должно прийти даже если приложение закрыто

## Шаг 4: Настройка уведомлений (опционально)

В cron-job.org можно настроить уведомления о статусе выполнения:

1. Перейдите в настройки cron job
2. Найдите раздел **"Notifications"** или **"Alert"**
3. Настройте:
   - **Email notifications** - уведомления на email
   - **Only on failure** - только при ошибках
   - **Always** - всегда

## Важные детали

### URL API endpoint

Убедитесь, что URL правильный:
- Формат: `https://your-project.vercel.app/api/push/process-reminders`
- Метод: `POST`
- Body: пустой или `{}`

### Проверка доступности API

Проверьте, что API endpoint доступен:

```bash
# В терминале или через Postman
curl -X POST https://your-project.vercel.app/api/push/process-reminders
```

Должен вернуться ответ:
```json
{
  "success": true,
  "processed": 0,
  "message": "No reminders to process"
}
```

### CORS настройки

API endpoint уже настроен для работы с внешними сервисами. Если возникают проблемы с CORS:

1. Проверьте настройки CORS в `api/push/process-reminders.js`
2. Убедитесь, что переменная окружения `CORS_ALLOWED_ORIGINS` включает `*` или ваш домен

### Переменные окружения

Убедитесь, что в Vercel настроены все необходимые переменные:
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `VAPID_PUBLIC_KEY`
- `VAPID_PRIVATE_KEY`
- `VAPID_SUBJECT`

## Troubleshooting

### Проблема 1: Cron job возвращает 404

**Причина:** Неправильный URL или API endpoint не существует

**Решение:**
1. Проверьте URL в настройках cron job
2. Проверьте, что проект задеплоен в Vercel
3. Проверьте, что файл `api/push/process-reminders.js` существует

### Проблема 2: Cron job возвращает 500

**Причина:** Ошибка в API endpoint или отсутствуют переменные окружения

**Решение:**
1. Проверьте логи Vercel: Vercel Dashboard → Functions → api/push/process-reminders → View Logs
2. Проверьте переменные окружения в Vercel
3. Проверьте, что все переменные добавлены для Production среды

### Проблема 3: Cron job не запускается

**Причина:** Cron job не активирован или неправильное расписание

**Решение:**
1. Проверьте, что cron job активирован (галочка включена)
2. Проверьте расписание (должно быть `*/5 * * * *`)
3. Проверьте часовой пояс

### Проблема 4: Напоминания не обрабатываются

**Причина:** API вызывается, но напоминания не находятся

**Решение:**
1. Проверьте логи Vercel на наличие ошибок
2. Проверьте, что есть напоминания в базе:
   ```javascript
   window.debugReminders.checkScheduledReminders(1)
   ```
3. Проверьте, что время напоминания уже наступило

## Альтернативные настройки расписания

Если нужно другое расписание:

- **Каждые 1 минуту:** `* * * * *`
- **Каждые 5 минут:** `*/5 * * * *`
- **Каждые 10 минут:** `*/10 * * * *`
- **Каждые 15 минут:** `*/15 * * * *`
- **Каждый час:** `0 * * * *`

## Бесплатный план cron-job.org

Бесплатный план включает:
- ✅ Неограниченное количество cron jobs
- ✅ До 50 выполнений в день на cron job
- ✅ HTTP/HTTPS запросы
- ✅ Email уведомления

Для обработки каждые 5 минут:
- 5 минут × 60 минут = 12 раз в час
- 12 × 24 часа = 288 раз в день
- Это больше 50 выполнений, но бесплатный план может работать с ограничениями

**Рекомендация:** Используйте расписание `*/10 * * * *` (каждые 10 минут) для бесплатного плана:
- 10 минут × 6 раз в час = 6 раз в час
- 6 × 24 часа = 144 раз в день
- Это все еще больше 50, но может быть приемлемо

Или используйте **Vercel cron job** как основной способ, а **cron-job.org** как запасной вариант.

## Проверка работы

После настройки проверьте:

1. **В cron-job.org:**
   - Последние выполнения показывают статус **200 OK**
   - Логи показывают успешные запросы

2. **В Vercel:**
   - Логи показывают обработку напоминаний каждые 5 минут
   - Нет ошибок в логах

3. **В приложении:**
   - Напоминания приходят даже когда приложение закрыто
   - Уведомления доставляются вовремя

## Итог

После настройки cron-job.org:
- ✅ Напоминания будут обрабатываться каждые 5 минут (или выбранный интервал)
- ✅ Уведомления будут приходить даже когда приложение закрыто
- ✅ Не зависит от того, открыто приложение или нет

Если возникнут проблемы, проверьте логи в cron-job.org и Vercel Dashboard.

