# Система достижений с проверкой истории и уведомлениями

## Новые возможности

### 1. Проверка истории семьи
Теперь можно проверить всю историю семьи и выдать недостающие достижения всем членам семьи.

### 2. Пуш-уведомления
Система отправляет пуш-уведомления при получении новых достижений.

## Установка

### Шаг 1: Выполните SQL скрипты
Запустите в Supabase SQL Editor в следующем порядке:

1. **`fix_achievement_function_improved.sql`** - исправленная функция достижений
2. **`check_family_history_achievements.sql`** - функция проверки истории семьи
3. **`achievement_notifications.sql`** - функции для уведомлений

### Шаг 2: Обновите код приложения
Код уже обновлен с новыми функциями:
- ✅ Обновлен `achievementService.ts` с новыми методами
- ✅ Обновлен `Dashboard.tsx` с поддержкой уведомлений
- ✅ Добавлен компонент `AchievementHistoryChecker.tsx`

### Шаг 3: Протестируйте систему
Запустите `test_achievement_system.sql` для проверки работы всех функций.

## Использование

### Проверка истории семьи
1. Откройте приложение
2. Перейдите в раздел "Достижения"
3. Нажмите кнопку **"Проверить историю семьи"**
4. Система проверит всю историю и выдаст недостающие достижения

### Настройка уведомлений
1. В разделе "Достижения" нажмите **"Разрешить уведомления"**
2. Подтвердите разрешение в браузере
3. Теперь при получении достижений будут приходить пуш-уведомления

### Тестирование уведомлений
1. Нажмите **"Тестовое уведомление"** для проверки
2. Запишите действие (смена подгузника, кормление и т.д.)
3. При получении достижения придет уведомление

## Функции базы данных

### `check_family_history_and_award_achievements(family_id)`
Проверяет всю историю семьи и выдает недостающие достижения всем членам семьи.

**Возвращает:**
- `user_id` - ID пользователя
- `user_name` - имя пользователя
- `achievement_id` - ID достижения
- `achievement_name` - название достижения
- `points` - очки
- `coins_reward` - монеты
- `rarity` - редкость

### `get_achievement_notifications(family_id, user_id, limit)`
Получает уведомления о достижениях для пользователя.

### `send_achievement_notifications(family_id, achievement_data)`
Отправляет уведомления всем членам семьи о новом достижении.

## Типы достижений, которые проверяются

### Серии (Streaks)
- **Кормление**: максимальная серия кормлений за день
- **Смена подгузников**: максимальная серия смен за день
- **Сон**: максимальная серия записей сна за день
- **Активности**: максимальная серия активностей за день
- **Купание**: максимальная серия купаний за день

### Первые действия
- Первое кормление
- Первая смена подгузника
- Первое купание
- Первая активность

### Общие достижения
- Общее количество достижений пользователя
- Консистентность использования (количество дней)
- Комбо достижения (максимальное количество действий за день)

## Отладка

### Если достижения не выдаются:
1. Проверьте логи в консоли браузера
2. Запустите `test_achievement_system.sql`
3. Проверьте, достаточно ли данных в истории
4. Убедитесь, что достижения не получены ранее

### Если уведомления не работают:
1. Проверьте разрешения браузера
2. Убедитесь, что сайт добавлен в избранное (для мобильных)
3. Проверьте, что браузер поддерживает уведомления

## Примеры использования

### Проверка истории конкретной семьи
```sql
SELECT * FROM check_family_history_and_award_achievements(1);
```

### Получение уведомлений пользователя
```sql
SELECT * FROM get_achievement_notifications(1, 1, 5);
```

### Отправка тестового уведомления
```sql
SELECT * FROM send_achievement_notifications(1, '{"achievement_name": "Тест", "points": 10, "coins_reward": 5, "rarity": "common"}');
```

## Ожидаемый результат

После установки и настройки:
- ✅ При записи действий автоматически проверяются достижения
- ✅ При получении достижения приходят пуш-уведомления
- ✅ Можно проверить всю историю семьи и выдать недостающие достижения
- ✅ Все члены семьи получают достижения на основе общей истории
- ✅ Система работает стабильно и надежно
