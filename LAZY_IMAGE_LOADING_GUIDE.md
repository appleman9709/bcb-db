# Ленивая загрузка изображений

## Обзор

Система предзагрузки изображений была переведена в "ленивый" режим для снижения нагрузки на сеть и CPU при запуске приложения. Теперь изображения загружаются только при необходимости и кэшируются для повторного использования.

## Основные изменения

### 1. Ленивый загрузчик (`src/lib/lazyImageLoader.ts`)

- **Кэширование**: Все загруженные изображения сохраняются в памяти
- **Приоритеты**: Поддержка высокого, среднего и низкого приоритета загрузки
- **Батчинг**: Ограничение количества одновременных загрузок
- **Таймауты**: Автоматическое завершение загрузки при превышении времени ожидания

### 2. Обновленный контекст (`src/contexts/ImagePreloadContext.tsx`)

- Загружает только критические изображения при инициализации (10 изображений вместо 80+)
- Предоставляет методы для ленивой загрузки
- Отслеживает статистику кэша

### 3. Компоненты для ленивой загрузки

#### `LazyImage` (`src/components/LazyImage.tsx`)
Компонент для отображения изображений с автоматической загрузкой:

```tsx
<LazyImage 
  src="/icons/feeding.png" 
  alt="Кормление" 
  priority="high"
  fallback="/icons/baby.png"
/>
```

#### `CategoryPreloader` (`src/components/CategoryPreloader.tsx`)
Предзагружает изображения по категориям:

```tsx
<CategoryPreloader 
  category="actions" 
  priority="high" 
  delay={500} 
/>
```

## Категории изображений

### Критические (загружаются при старте)
- Основные иконки действий
- Навигационные иконки
- Иконка малыша

### По категориям
- **actions**: Иконки действий (кормление, смена подгузника, купание)
- **tamagotchi**: Иконки для тамагочи (губка, мама, сумка, подгузник)
- **charts**: Иконки для графиков (вес, рост, часы)
- **navigation**: SVG иконки навигации
- **modals**: Иконки для модальных окон

## Использование

### В компонентах страниц

```tsx
// Dashboard.tsx
<CategoryPreloader category="actions" priority="high" delay={500} />

// TamagotchiPage.tsx  
<CategoryPreloader category="tamagotchi" priority="high" delay={300} />

// TetrisPage.tsx
<CategoryPreloader category="navigation" priority="medium" delay={200} />
```

### Программная загрузка

```tsx
import { useImagePreloadContext } from '../contexts/ImagePreloadContext'

function MyComponent() {
  const { loadImage, preloadImages, isImageLoaded } = useImagePreloadContext()
  
  const handleLoadImage = async () => {
    await loadImage('/icons/specific-icon.png')
  }
  
  const handlePreloadCategory = async () => {
    await preloadImages(['/icons/img1.png', '/icons/img2.png'], 'medium')
  }
}
```

## Преимущества

1. **Быстрый старт**: Приложение запускается быстрее, загружая только критические ресурсы
2. **Снижение нагрузки**: Изображения загружаются по мере необходимости
3. **Кэширование**: Повторное использование уже загруженных изображений
4. **Приоритизация**: Важные изображения загружаются первыми
5. **Отказоустойчивость**: Graceful handling ошибок загрузки

## Настройки

### Приоритеты загрузки
- **high**: Загружается немедленно, все изображения параллельно
- **medium**: Загружается батчами по 3 изображения с паузами
- **low**: Загружается по 1 изображению с паузами

### Таймауты
- Таймаут загрузки одного изображения: 10 секунд
- Пауза между батчами: 100мс

## Мониторинг

Статистику кэша можно получить через контекст:

```tsx
const { getCacheStats } = useImagePreloadContext()
const stats = getCacheStats()
// { total: 25, loaded: 20, loading: 2, errors: 3 }
```

## Миграция

Старая система массовой предзагрузки была удалена из:
- `App.tsx` - убраны `CriticalImagePreloader` и `ImagePreloader`
- `LoadingScreen.tsx` - обновлен для работы с ленивой загрузкой
- `ImagePreloader.tsx` - переписан для работы по категориям

Все существующие компоненты продолжают работать без изменений благодаря обратной совместимости.
