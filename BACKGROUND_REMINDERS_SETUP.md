# Настройка фоновой обработки напоминаний

## Обзор

Теперь напоминания будут обрабатываться даже когда приложение закрыто. Реализовано три способа обработки:

1. **Vercel Cron Job** - каждые 5 минут (основной способ)
2. **Periodic Background Sync** - для PWA (если поддерживается браузером)
3. **Client-side processor** - когда приложение открыто (каждую минуту)

## Как это работает

### 1. Vercel Cron Job (основной способ)

Настроен cron job в `vercel.json`, который запускается каждые 5 минут:

```json
{
  "crons": [
    {
      "path": "/api/push/process-reminders",
      "schedule": "*/5 * * * *"
    }
  ]
}
```

**Преимущества:**
- ✅ Работает даже когда приложение закрыто
- ✅ Не зависит от браузера пользователя
- ✅ Надежно и стабильно

**Ограничения:**
- ⚠️ На Vercel Hobby плане может быть ограничение частоты cron jobs
- ⚠️ Если Hobby план не поддерживает частые cron jobs, используйте внешний сервис (см. ниже)

### 2. Periodic Background Sync (для PWA)

Если пользователь установил приложение как PWA, Service Worker может обрабатывать напоминания в фоне через Periodic Background Sync API.

**Преимущества:**
- ✅ Работает в фоне даже когда приложение закрыто
- ✅ Не требует внешних сервисов

**Ограничения:**
- ⚠️ Требует установки приложения как PWA
- ⚠️ Поддерживается не всеми браузерами
- ⚠️ Браузер может ограничивать частоту синхронизации

### 3. Client-side Processor (когда приложение открыто)

Обработчик на клиенте проверяет напоминания каждую минуту, когда приложение открыто.

**Преимущества:**
- ✅ Быстрая обработка (каждую минуту)
- ✅ Не зависит от внешних сервисов

**Ограничения:**
- ⚠️ Работает только когда приложение открыто

## Настройка

### Шаг 1: Проверьте Vercel Cron Job

После деплоя проверьте, что cron job работает:

1. Vercel Dashboard → **Deployments**
2. Найдите последний deployment
3. Перейдите в **Functions → Cron Jobs**
4. Убедитесь, что cron job для `/api/push/process-reminders` активен

### Шаг 2: Проверьте логи Vercel

1. Vercel Dashboard → **Deployments**
2. Выберите deployment → **Functions → api/push/process-reminders**
3. Нажмите **View Logs**
4. Проверьте, что cron job запускается каждые 5 минут

### Шаг 3: Установите приложение как PWA (опционально)

Для работы Periodic Background Sync:

1. Откройте приложение в браузере
2. Нажмите на иконку "Установить" в адресной строке
3. Или в меню браузера выберите "Установить приложение"
4. После установки приложение будет работать как PWA

## Альтернатива: Внешний Cron Сервис

Если Vercel Hobby план не поддерживает частые cron jobs, используйте внешний сервис:

### Вариант 1: cron-job.org (бесплатно)

1. Зарегистрируйтесь на [cron-job.org](https://cron-job.org)
2. Создайте новый cron job:
   - **URL:** `https://your-project.vercel.app/api/push/process-reminders`
   - **Method:** `POST`
   - **Schedule:** `*/5 * * * *` (каждые 5 минут)
   - **Time zone:** ваш часовой пояс
3. Сохраните cron job

### Вариант 2: EasyCron (бесплатно)

1. Зарегистрируйтесь на [EasyCron](https://www.easycron.com)
2. Создайте новый cron job:
   - **URL:** `https://your-project.vercel.app/api/push/process-reminders`
   - **Method:** `POST`
   - **Cron Expression:** `*/5 * * * *`
   - **Time zone:** ваш часовой пояс
3. Сохраните cron job

### Вариант 3: Supabase Edge Functions + pg_cron

1. Создайте Supabase Edge Function для обработки напоминаний
2. Настройте pg_cron в Supabase для периодического вызова функции
3. Функция будет обрабатывать напоминания независимо от Vercel

## Проверка работы

### Проверка 1: Логи Vercel

```bash
# Проверьте логи Vercel через Dashboard
# Или через CLI:
vercel logs --follow
```

Должны быть логи каждые 5 минут:
```
[process-reminders] Found X reminder(s) to process
```

### Проверка 2: Создайте тестовое напоминание

```javascript
// В консоли браузера
window.debugReminders.createTestReminder(1, 'diaper')
```

Подождите 5 минут - уведомление должно прийти даже если приложение закрыто.

### Проверка 3: Проверьте статус напоминаний

```javascript
// В консоли браузера
window.debugReminders.checkScheduledReminders(1)
```

Через 5 минут после наступления времени напоминания, статус должен измениться на `sent`.

## Troubleshooting

### Проблема 1: Cron job не запускается

**Решение:**
1. Проверьте, что cron job настроен в `vercel.json`
2. Проверьте, что проект перезапущен после изменений
3. Проверьте логи Vercel на наличие ошибок
4. Если Hobby план не поддерживает частые cron jobs, используйте внешний сервис

### Проблема 2: Напоминания не обрабатываются

**Решение:**
1. Проверьте, что API endpoint доступен: `https://your-project.vercel.app/api/push/process-reminders`
2. Проверьте переменные окружения в Vercel (SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, VAPID keys)
3. Проверьте логи Vercel на наличие ошибок

### Проблема 3: Periodic Background Sync не работает

**Решение:**
1. Убедитесь, что приложение установлено как PWA
2. Проверьте, что браузер поддерживает Periodic Background Sync (Chrome, Edge)
3. Проверьте разрешения браузера для PWA
4. Это не критично - cron job все равно будет работать

## Мониторинг

### Проверка статистики

В Vercel Dashboard → Functions → api/push/process-reminders можно увидеть:
- Количество вызовов
- Среднее время выполнения
- Ошибки (если есть)

### Логи в консоли

Если приложение открыто, в консоли будут логи:
- `✅ Processed X reminders: Y sent, Z failed` (если есть напоминания)
- `ℹ️ No reminders to process` (если напоминаний нет)

## Рекомендации

1. **Для продакшена:** Используйте Vercel cron job как основной способ обработки
2. **Для PWA:** Periodic Background Sync будет дополнительным механизмом
3. **Для надежности:** Настройте внешний cron сервис как запасной вариант

## Итог

Теперь напоминания будут обрабатываться:
- ✅ Каждые 5 минут через Vercel cron job (даже когда приложение закрыто)
- ✅ Каждую минуту через client-side processor (когда приложение открыто)
- ✅ Через Periodic Background Sync (если установлено как PWA)

Это обеспечивает надежную доставку напоминаний в любое время!

