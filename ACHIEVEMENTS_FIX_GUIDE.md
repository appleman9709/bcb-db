# Исправление проблемы с достижениями

## Проблема
Достижения не срабатывают при смене подгузника из-за неправильной логики в функции `check_and_award_achievements`.

## Причина
В старых версиях функции есть несколько проблем:

1. **Неправильная логика проверки**: Функция проверяет `CASE activity_type` вместо `CASE achievement_record.criteria->>'type'`
2. **Неправильный подсчет**: Используется `ORDER BY` в `SELECT COUNT(*)`, что не имеет смысла
3. **Отсутствие проверки типа критерия**: Функция не проверяет правильный тип критерия достижения

## Решение

### Шаг 1: Выполните исправленную функцию
Запустите файл `fix_achievement_function.sql` в Supabase SQL Editor. Эта функция исправляет все проблемы с логикой проверки достижений.

### Шаг 2: Проверьте данные
Запустите файл `check_achievements_data.sql` для проверки:
- Есть ли достижения в базе данных
- Правильно ли настроены критерии достижений
- Есть ли записи смены подгузников

### Шаг 3: Протестируйте функцию
Запустите файл `test_achievements.sql` для тестирования работы функции достижений.

## Что исправлено

1. **Правильная логика проверки**: Теперь функция проверяет `achievement_record.criteria->>'type'` вместо `activity_type`
2. **Корректный подсчет**: Убран неправильный `ORDER BY` из `SELECT COUNT(*)`
3. **Добавлены проверки**: Добавлены проверки для `first_action`, `total_count`, `consistency`
4. **Улучшена обработка ошибок**: Добавлены проверки на существование данных

## Ожидаемый результат
После выполнения исправлений достижения должны корректно срабатывать при:
- Смене подгузника (diaper_streak)
- Кормлении (feeding_streak)
- Купании (bath_streak)
- Активностях (activity_streak)
- Комбо действий (combo)
- Первых действиях (first_action)

## Проверка работы
1. Запишите смену подгузника через приложение
2. Проверьте, появилось ли уведомление о достижении
3. Проверьте вкладку "Достижения" - должно появиться новое достижение
4. Проверьте статистику семьи - должны обновиться очки и монеты
